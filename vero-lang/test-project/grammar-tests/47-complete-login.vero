# Test: Complete Login Flow
# Category: Integration - Login (New PAGEACTIONS Pattern)

PAGE LoginPage {
    FIELD emailInput = "input[type='email']"
    FIELD passwordInput = "input[type='password']"
    FIELD submitBtn = "button[type='submit']"
    FIELD errorMsg = ".error-message"
    FIELD rememberMe = "#remember"
}

PAGE DashboardPage {
    FIELD header = ".dashboard-header"
    FIELD welcomeMsg = ".welcome-message"
    FIELD logoutBtn = "Logout"
}

PAGEACTIONS LoginPageActions FOR LoginPage {
    enterEmail WITH value {
        FILL emailInput WITH value
    }

    enterPassword WITH value {
        FILL passwordInput WITH value
    }

    clickSubmit {
        CLICK submitBtn
    }

    checkRememberMe {
        CHECK rememberMe
    }

    login WITH email, password {
        FILL emailInput WITH email
        FILL passwordInput WITH password
        CLICK submitBtn
    }

    loginWithRemember WITH email, password {
        FILL emailInput WITH email
        FILL passwordInput WITH password
        CHECK rememberMe
        CLICK submitBtn
    }

    isErrorVisible RETURNS FLAG {
        RETURN VISIBLE OF errorMsg
    }

    getErrorText RETURNS TEXT {
        RETURN TEXT OF errorMsg
    }

    isEmailEmpty RETURNS FLAG {
        RETURN VISIBLE OF emailInput
    }

    getEmailValue RETURNS TEXT {
        RETURN TEXT OF emailInput
    }

    awaitLoginPage {
        WAIT FOR emailInput
    }
}

PAGEACTIONS DashboardPageActions FOR DashboardPage {
    clickLogout {
        CLICK logoutBtn
    }

    logout {
        CLICK logoutBtn
        WAIT 1 SECONDS
    }

    isHeaderVisible RETURNS FLAG {
        RETURN VISIBLE OF header
    }

    getWelcomeText RETURNS TEXT {
        RETURN TEXT OF welcomeMsg
    }

    awaitDashboard {
        WAIT FOR header
    }
}

FEATURE UserAuthentication {
    USE LoginPageActions
    USE DashboardPageActions

    BEFORE EACH {
        OPEN "/login"
        WAIT 1 SECONDS
    }

    AFTER EACH {
        TAKE SCREENSHOT "test-result"
    }

    SCENARIO ValidLogin @smoke @critical {
        PERFORM LoginPageActions.login WITH "admin@example.com", "password123"
        WAIT 2 SECONDS

        FLAG isHeader = PERFORM DashboardPageActions.isHeaderVisible
        VERIFY isHeader IS TRUE

        TEXT welcomeText = PERFORM DashboardPageActions.getWelcomeText
        VERIFY welcomeText CONTAINS "Welcome"
    }

    SCENARIO InvalidCredentials @regression {
        PERFORM LoginPageActions.login WITH "invalid@example.com", "wrongpassword"

        FLAG hasError = PERFORM LoginPageActions.isErrorVisible
        VERIFY hasError IS TRUE

        TEXT errorText = PERFORM LoginPageActions.getErrorText
        VERIFY errorText CONTAINS "Invalid"
    }

    SCENARIO EmptyCredentials @regression {
        PERFORM LoginPageActions.clickSubmit

        FLAG hasError = PERFORM LoginPageActions.isErrorVisible
        VERIFY hasError IS TRUE
    }

    SCENARIO RememberMe @regression {
        PERFORM LoginPageActions.loginWithRemember WITH "user@example.com", "password"

        FLAG isHeader = PERFORM DashboardPageActions.isHeaderVisible
        VERIFY isHeader IS TRUE

        PERFORM DashboardPageActions.logout

        TEXT emailValue = PERFORM LoginPageActions.getEmailValue
        VERIFY emailValue CONTAINS "user@example.com"
    }
}
