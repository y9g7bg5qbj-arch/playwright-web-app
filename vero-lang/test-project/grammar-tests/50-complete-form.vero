# Test: Complete Form Validation
# Category: Integration - Forms (New PAGEACTIONS Pattern)

PAGE RegistrationPage {
    FIELD firstNameInput = "#first-name"
    FIELD lastNameInput = "#last-name"
    FIELD emailInput = "#email"
    FIELD passwordInput = "#password"
    FIELD confirmPasswordInput = "#confirm-password"
    FIELD phoneInput = "#phone"
    FIELD dateOfBirthInput = "#dob"
    FIELD termsCheckbox = "#terms"
    FIELD newsletterCheckbox = "#newsletter"
    FIELD countryDropdown = "#country"
    FIELD submitBtn = "Create Account"

    # Error fields
    FIELD firstNameError = "#first-name-error"
    FIELD lastNameError = "#last-name-error"
    FIELD emailError = "#email-error"
    FIELD passwordError = "#password-error"
    FIELD confirmPasswordError = "#confirm-password-error"
    FIELD termsError = "#terms-error"

    # Success
    FIELD successMessage = ".success-message"
}

PAGEACTIONS RegistrationPageActions FOR RegistrationPage {
    # Setters
    enterFirstName WITH val {
        FILL firstNameInput WITH val
    }

    enterLastName WITH val {
        FILL lastNameInput WITH val
    }

    enterEmail WITH val {
        FILL emailInput WITH val
    }

    enterPassword WITH val {
        FILL passwordInput WITH val
    }

    enterConfirmPassword WITH val {
        FILL confirmPasswordInput WITH val
    }

    enterPhone WITH val {
        FILL phoneInput WITH val
    }

    selectCountry WITH country {
        SELECT country FROM countryDropdown
    }

    # Actions
    clickSubmit {
        CLICK submitBtn
    }

    acceptTerms {
        CHECK termsCheckbox
    }

    subscribeNewsletter {
        CHECK newsletterCheckbox
    }

    clearEmail {
        CLEAR emailInput
    }

    # Composite Actions
    fillBasicInfo WITH firstName, lastName, email {
        FILL firstNameInput WITH firstName
        FILL lastNameInput WITH lastName
        FILL emailInput WITH email
    }

    fillPassword WITH password, confirmPassword {
        FILL passwordInput WITH password
        FILL confirmPasswordInput WITH confirmPassword
    }

    fillOptional WITH phone, country {
        FILL phoneInput WITH phone
        SELECT country FROM countryDropdown
    }

    # Getters
    getEmailErrorText RETURNS TEXT {
        RETURN emailError
    }

    getPasswordErrorText RETURNS TEXT {
        RETURN passwordError
    }

    getConfirmPasswordErrorText RETURNS TEXT {
        RETURN confirmPasswordError
    }

    awaitRegistrationPage {
        WAIT FOR firstNameInput
    }
}

FEATURE FormValidation {
    USE RegistrationPageActions

    BEFORE EACH {
        OPEN "/register"
        WAIT 1 SECONDS
    }

    AFTER EACH {
        TAKE SCREENSHOT "form-state"
    }

    SCENARIO SuccessfulRegistration @smoke @critical {
        PERFORM RegistrationPageActions.fillBasicInfo WITH "John", "Doe", "john.doe@example.com"
        PERFORM RegistrationPageActions.fillPassword WITH "SecurePass123!", "SecurePass123!"
        PERFORM RegistrationPageActions.fillOptional WITH "+1234567890", "United States"
        PERFORM RegistrationPageActions.acceptTerms
        PERFORM RegistrationPageActions.clickSubmit
        WAIT 2 SECONDS

        VERIFY RegistrationPage.successMessage IS VISIBLE
    }

    SCENARIO AllFieldsRequired @regression {
        PERFORM RegistrationPageActions.clickSubmit

        VERIFY RegistrationPage.firstNameError IS VISIBLE
        VERIFY RegistrationPage.lastNameError IS VISIBLE
        VERIFY RegistrationPage.emailError IS VISIBLE
        VERIFY RegistrationPage.passwordError IS VISIBLE
        VERIFY RegistrationPage.termsError IS VISIBLE
    }

    SCENARIO InvalidEmailFormat @regression {
        PERFORM RegistrationPageActions.fillBasicInfo WITH "John", "Doe", "invalid-email"
        PERFORM RegistrationPageActions.clickSubmit

        VERIFY RegistrationPage.emailError IS VISIBLE

        TEXT errorText = RegistrationPageActions.getEmailErrorText
        VERIFY errorText IS CONTAINS "valid email"
    }

    SCENARIO PasswordMismatch @regression {
        PERFORM RegistrationPageActions.fillBasicInfo WITH "John", "Doe", "john@example.com"
        PERFORM RegistrationPageActions.fillPassword WITH "Password123!", "DifferentPassword!"
        PERFORM RegistrationPageActions.clickSubmit

        VERIFY RegistrationPage.confirmPasswordError IS VISIBLE

        TEXT errorText = RegistrationPageActions.getConfirmPasswordErrorText
        VERIFY errorText IS CONTAINS "match"
    }

    SCENARIO PasswordTooWeak @regression {
        PERFORM RegistrationPageActions.fillBasicInfo WITH "John", "Doe", "john@example.com"
        PERFORM RegistrationPageActions.fillPassword WITH "weak", "weak"
        PERFORM RegistrationPageActions.clickSubmit

        VERIFY RegistrationPage.passwordError IS VISIBLE

        TEXT errorText = RegistrationPageActions.getPasswordErrorText
        VERIFY errorText IS CONTAINS "stronger"
    }

    SCENARIO TermsNotAccepted @regression {
        PERFORM RegistrationPageActions.fillBasicInfo WITH "John", "Doe", "john@example.com"
        PERFORM RegistrationPageActions.fillPassword WITH "SecurePass123!", "SecurePass123!"
        PERFORM RegistrationPageActions.clickSubmit

        VERIFY RegistrationPage.termsError IS VISIBLE
    }

    SCENARIO ClearAndRefill @regression {
        # Fill with errors
        PERFORM RegistrationPageActions.enterEmail WITH "bad-email"
        PERFORM RegistrationPageActions.clickSubmit

        VERIFY RegistrationPage.emailError IS VISIBLE

        # Clear and correct
        PERFORM RegistrationPageActions.clearEmail
        PERFORM RegistrationPageActions.enterEmail WITH "good@example.com"

        VERIFY RegistrationPage.emailError IS HIDDEN
    }
}
