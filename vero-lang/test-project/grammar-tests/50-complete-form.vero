# Test: Complete Form Validation
# Category: Integration - Forms (New PAGEACTIONS Pattern)

PAGE RegistrationPage {
    FIELD firstNameInput = "#first-name"
    FIELD lastNameInput = "#last-name"
    FIELD emailInput = "#email"
    FIELD passwordInput = "#password"
    FIELD confirmPasswordInput = "#confirm-password"
    FIELD phoneInput = "#phone"
    FIELD dateOfBirthInput = "#dob"
    FIELD termsCheckbox = "#terms"
    FIELD newsletterCheckbox = "#newsletter"
    FIELD countryDropdown = "#country"
    FIELD submitBtn = "Create Account"

    # Error fields
    FIELD firstNameError = "#first-name-error"
    FIELD lastNameError = "#last-name-error"
    FIELD emailError = "#email-error"
    FIELD passwordError = "#password-error"
    FIELD confirmPasswordError = "#confirm-password-error"
    FIELD termsError = "#terms-error"

    # Success
    FIELD successMessage = ".success-message"
}

PAGEACTIONS RegistrationPageActions FOR RegistrationPage {
    # Setters
    enterFirstName WITH value {
        FILL firstNameInput WITH value
    }

    enterLastName WITH value {
        FILL lastNameInput WITH value
    }

    enterEmail WITH value {
        FILL emailInput WITH value
    }

    enterPassword WITH value {
        FILL passwordInput WITH value
    }

    enterConfirmPassword WITH value {
        FILL confirmPasswordInput WITH value
    }

    enterPhone WITH value {
        FILL phoneInput WITH value
    }

    selectCountry WITH country {
        SELECT country FROM countryDropdown
    }

    # Actions
    clickSubmit {
        CLICK submitBtn
    }

    acceptTerms {
        CHECK termsCheckbox
    }

    subscribeNewsletter {
        CHECK newsletterCheckbox
    }

    clearEmail {
        CLEAR emailInput
    }

    # Composite Actions
    fillBasicInfo WITH firstName, lastName, email {
        FILL firstNameInput WITH firstName
        FILL lastNameInput WITH lastName
        FILL emailInput WITH email
    }

    fillPassword WITH password, confirmPassword {
        FILL passwordInput WITH password
        FILL confirmPasswordInput WITH confirmPassword
    }

    fillOptional WITH phone, country {
        FILL phoneInput WITH phone
        SELECT country FROM countryDropdown
    }

    # Getters
    isFirstNameErrorVisible RETURNS FLAG {
        RETURN VISIBLE OF firstNameError
    }

    isLastNameErrorVisible RETURNS FLAG {
        RETURN VISIBLE OF lastNameError
    }

    isEmailErrorVisible RETURNS FLAG {
        RETURN VISIBLE OF emailError
    }

    isPasswordErrorVisible RETURNS FLAG {
        RETURN VISIBLE OF passwordError
    }

    isConfirmPasswordErrorVisible RETURNS FLAG {
        RETURN VISIBLE OF confirmPasswordError
    }

    isTermsErrorVisible RETURNS FLAG {
        RETURN VISIBLE OF termsError
    }

    isSuccessMessageVisible RETURNS FLAG {
        RETURN VISIBLE OF successMessage
    }

    getEmailErrorText RETURNS TEXT {
        RETURN TEXT OF emailError
    }

    getPasswordErrorText RETURNS TEXT {
        RETURN TEXT OF passwordError
    }

    getConfirmPasswordErrorText RETURNS TEXT {
        RETURN TEXT OF confirmPasswordError
    }

    awaitRegistrationPage {
        WAIT FOR firstNameInput
    }
}

FEATURE FormValidation {
    USE RegistrationPageActions

    BEFORE EACH {
        OPEN "/register"
        WAIT 1 SECONDS
    }

    AFTER EACH {
        TAKE SCREENSHOT "form-state"
    }

    SCENARIO SuccessfulRegistration @smoke @critical {
        PERFORM RegistrationPageActions.fillBasicInfo WITH "John", "Doe", "john.doe@example.com"
        PERFORM RegistrationPageActions.fillPassword WITH "SecurePass123!", "SecurePass123!"
        PERFORM RegistrationPageActions.fillOptional WITH "+1234567890", "United States"
        PERFORM RegistrationPageActions.acceptTerms
        PERFORM RegistrationPageActions.clickSubmit
        WAIT 2 SECONDS

        FLAG isSuccess = PERFORM RegistrationPageActions.isSuccessMessageVisible
        VERIFY isSuccess IS TRUE
    }

    SCENARIO AllFieldsRequired @regression {
        PERFORM RegistrationPageActions.clickSubmit

        FLAG hasFirstNameError = PERFORM RegistrationPageActions.isFirstNameErrorVisible
        VERIFY hasFirstNameError IS TRUE

        FLAG hasLastNameError = PERFORM RegistrationPageActions.isLastNameErrorVisible
        VERIFY hasLastNameError IS TRUE

        FLAG hasEmailError = PERFORM RegistrationPageActions.isEmailErrorVisible
        VERIFY hasEmailError IS TRUE

        FLAG hasPasswordError = PERFORM RegistrationPageActions.isPasswordErrorVisible
        VERIFY hasPasswordError IS TRUE

        FLAG hasTermsError = PERFORM RegistrationPageActions.isTermsErrorVisible
        VERIFY hasTermsError IS TRUE
    }

    SCENARIO InvalidEmailFormat @regression {
        PERFORM RegistrationPageActions.fillBasicInfo WITH "John", "Doe", "invalid-email"
        PERFORM RegistrationPageActions.clickSubmit

        FLAG hasEmailError = PERFORM RegistrationPageActions.isEmailErrorVisible
        VERIFY hasEmailError IS TRUE

        TEXT errorText = PERFORM RegistrationPageActions.getEmailErrorText
        VERIFY errorText CONTAINS "valid email"
    }

    SCENARIO PasswordMismatch @regression {
        PERFORM RegistrationPageActions.fillBasicInfo WITH "John", "Doe", "john@example.com"
        PERFORM RegistrationPageActions.fillPassword WITH "Password123!", "DifferentPassword!"
        PERFORM RegistrationPageActions.clickSubmit

        FLAG hasError = PERFORM RegistrationPageActions.isConfirmPasswordErrorVisible
        VERIFY hasError IS TRUE

        TEXT errorText = PERFORM RegistrationPageActions.getConfirmPasswordErrorText
        VERIFY errorText CONTAINS "match"
    }

    SCENARIO PasswordTooWeak @regression {
        PERFORM RegistrationPageActions.fillBasicInfo WITH "John", "Doe", "john@example.com"
        PERFORM RegistrationPageActions.fillPassword WITH "weak", "weak"
        PERFORM RegistrationPageActions.clickSubmit

        FLAG hasError = PERFORM RegistrationPageActions.isPasswordErrorVisible
        VERIFY hasError IS TRUE

        TEXT errorText = PERFORM RegistrationPageActions.getPasswordErrorText
        VERIFY errorText CONTAINS "stronger"
    }

    SCENARIO TermsNotAccepted @regression {
        PERFORM RegistrationPageActions.fillBasicInfo WITH "John", "Doe", "john@example.com"
        PERFORM RegistrationPageActions.fillPassword WITH "SecurePass123!", "SecurePass123!"
        PERFORM RegistrationPageActions.clickSubmit

        FLAG hasError = PERFORM RegistrationPageActions.isTermsErrorVisible
        VERIFY hasError IS TRUE
    }

    SCENARIO ClearAndRefill @regression {
        # Fill with errors
        PERFORM RegistrationPageActions.enterEmail WITH "bad-email"
        PERFORM RegistrationPageActions.clickSubmit

        FLAG hasError = PERFORM RegistrationPageActions.isEmailErrorVisible
        VERIFY hasError IS TRUE

        # Clear and correct
        PERFORM RegistrationPageActions.clearEmail
        PERFORM RegistrationPageActions.enterEmail WITH "good@example.com"

        FLAG noError = PERFORM RegistrationPageActions.isEmailErrorVisible
        VERIFY noError IS NOT TRUE
    }
}
