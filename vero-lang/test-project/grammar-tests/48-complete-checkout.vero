# Test: Complete E-Commerce Checkout Flow
# Category: Integration - E-Commerce (New PAGEACTIONS Pattern)

PAGE ProductPage {
    FIELD productTitle = ".product-title"
    FIELD price = ".product-price"
    FIELD addToCartBtn = "Add to Cart"
    FIELD quantityInput = "#quantity"
}

PAGE CartPage {
    FIELD cartItems = ".cart-item"
    FIELD cartTotal = ".cart-total"
    FIELD checkoutBtn = "Proceed to Checkout"
    FIELD emptyCart = ".empty-cart-message"
}

PAGE CheckoutPage {
    FIELD shippingAddress = "#address"
    FIELD shippingCity = "#city"
    FIELD shippingZip = "#zip"
    FIELD cardNumber = "#card-number"
    FIELD cardExpiry = "#expiry"
    FIELD cardCvv = "#cvv"
    FIELD placeOrderBtn = "Place Order"
    FIELD orderConfirmation = ".order-confirmation"
    FIELD orderNumber = ".order-number"
}

PAGEACTIONS ProductPageActions FOR ProductPage {
    clickAddToCart {
        CLICK addToCartBtn
    }

    addToCart {
        CLICK addToCartBtn
        WAIT 1 SECONDS
    }

    addMultiple WITH qty {
        CLEAR quantityInput
        FILL quantityInput WITH qty
        CLICK addToCartBtn
    }

    getProductTitle RETURNS TEXT {
        RETURN TEXT OF productTitle
    }

    getPrice RETURNS TEXT {
        RETURN TEXT OF price
    }
}

PAGEACTIONS CartPageActions FOR CartPage {
    clickCheckout {
        CLICK checkoutBtn
    }

    proceedToCheckout {
        CLICK checkoutBtn
        WAIT 2 SECONDS
    }

    isCartItemsVisible RETURNS FLAG {
        RETURN VISIBLE OF cartItems
    }

    isCartTotalVisible RETURNS FLAG {
        RETURN VISIBLE OF cartTotal
    }

    isEmptyCartVisible RETURNS FLAG {
        RETURN VISIBLE OF emptyCart
    }

    isCheckoutDisabled RETURNS FLAG {
        RETURN VISIBLE OF checkoutBtn
    }
}

PAGEACTIONS CheckoutPageActions FOR CheckoutPage {
    fillShipping WITH address, city, zip {
        FILL shippingAddress WITH address
        FILL shippingCity WITH city
        FILL shippingZip WITH zip
    }

    fillPayment WITH card, expiry, cvv {
        FILL cardNumber WITH card
        FILL cardExpiry WITH expiry
        FILL cardCvv WITH cvv
    }

    clickPlaceOrder {
        CLICK placeOrderBtn
    }

    isOrderConfirmationVisible RETURNS FLAG {
        RETURN VISIBLE OF orderConfirmation
    }

    isOrderNumberVisible RETURNS FLAG {
        RETURN VISIBLE OF orderNumber
    }

    getOrderNumber RETURNS TEXT {
        RETURN TEXT OF orderNumber
    }
}

FEATURE CheckoutFlow {
    USE ProductPageActions
    USE CartPageActions
    USE CheckoutPageActions

    BEFORE EACH {
        OPEN "/products"
    }

    AFTER EACH {
        TAKE SCREENSHOT "checkout-result"
    }

    SCENARIO CompleteCheckout @smoke @critical {
        # Add product to cart
        PERFORM ProductPageActions.addToCart

        FLAG hasItems = PERFORM CartPageActions.isCartItemsVisible
        VERIFY hasItems IS TRUE

        # Proceed to checkout
        PERFORM CartPageActions.proceedToCheckout

        # Fill shipping info
        PERFORM CheckoutPageActions.fillShipping WITH "123 Main St", "New York", "10001"

        # Fill payment info
        PERFORM CheckoutPageActions.fillPayment WITH "4111111111111111", "12/25", "123"

        # Place order
        PERFORM CheckoutPageActions.clickPlaceOrder
        WAIT 3 SECONDS

        # Verify confirmation
        FLAG isConfirmed = PERFORM CheckoutPageActions.isOrderConfirmationVisible
        VERIFY isConfirmed IS TRUE

        FLAG hasOrderNumber = PERFORM CheckoutPageActions.isOrderNumberVisible
        VERIFY hasOrderNumber IS TRUE

        TAKE SCREENSHOT "order-confirmation"
    }

    SCENARIO MultipleItemsCheckout @regression {
        PERFORM ProductPageActions.addMultiple WITH "3"

        FLAG hasTotal = PERFORM CartPageActions.isCartTotalVisible
        VERIFY hasTotal IS TRUE

        PERFORM CartPageActions.proceedToCheckout
    }

    SCENARIO EmptyCartCheckout @regression {
        OPEN "/cart"

        FLAG isEmpty = PERFORM CartPageActions.isEmptyCartVisible
        VERIFY isEmpty IS TRUE
    }
}
