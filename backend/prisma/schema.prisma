// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String     @map("password_hash")
  name         String?
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  workflows           Workflow[]
  agents              Agent[]
  globalVariables     GlobalVariable[]
  environments        Environment[]
  applications        Application[]        // Applications owned by this user
  applicationMembers  ApplicationMember[]  // Applications user is a member of

  @@map("users")
}

// ============================================
// APPLICATION & PROJECT MODELS (Multi-tenancy)
// ============================================

// Application - Top-level container for projects (e.g., "E-Commerce App", "Banking App")
model Application {
  id          String   @id @default(uuid())
  userId      String   @map("user_id") // Application owner
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  members        ApplicationMember[]
  projects       Project[]            // Projects within this application
  workflows      Workflow[]
  testDataSheets TestDataSheet[]
  scheduledTests ScheduledTest[]

  @@unique([userId, name]) // User can't have duplicate application names
  @@index([userId])
  @@map("applications")
}

// ApplicationMember - Team collaboration on applications
model ApplicationMember {
  id            String   @id @default(uuid())
  applicationId String   @map("application_id")
  userId        String   @map("user_id")
  role          String   @default("viewer") // owner, editor, viewer
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([applicationId, userId])
  @@index([applicationId])
  @@index([userId])
  @@map("application_members")
}

// Project - Container for test files within an application (e.g., "Login Tests", "Checkout Tests")
model Project {
  id            String   @id @default(uuid())
  applicationId String   @map("application_id")
  name          String
  description   String?
  veroPath      String?  @map("vero_path") // Path to project's Vero files folder
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@unique([applicationId, name]) // No duplicate project names within an application
  @@index([applicationId])
  @@map("projects")
}

model Workflow {
  id            String     @id @default(uuid())
  applicationId String?    @map("application_id") // Application this workflow belongs to
  userId        String     @map("user_id")
  name          String
  description   String?
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  application      Application?       @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  testFlows        TestFlow[]
  variables        WorkflowVariable[]
  objectRepository ObjectRepository?

  @@unique([applicationId, name]) // No duplicate workflow names within an application
  @@index([applicationId])
  @@index([userId])
  @@map("workflows")
}

model TestFlow {
  id         String      @id @default(uuid())
  workflowId String      @map("workflow_id")
  name       String
  code       String?
  nodes      String?     // JSON string of visual graph nodes
  edges      String?     // JSON string of visual graph edges
  variables  String?     // JSON string of flow-level variables
  dataSource String?     @map("data_source") // JSON string of data source config
  language   String      @default("typescript")
  tags       String      @default("[]") // JSON array of tags: ["smoke", "critical", "auth"]
  timeout    Int?        // Per-flow timeout override (ms)
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  workflow   Workflow    @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  executions Execution[]

  @@index([workflowId])
  @@map("test_flows")
}

model Execution {
  id                 String          @id @default(uuid())
  testFlowId         String          @map("test_flow_id")
  status             String          // pending, running, passed, failed, cancelled
  exitCode           Int?            @map("exit_code")
  target             String          // local, remote, docker
  agentId            String?         @map("agent_id")
  runConfigurationId String?         @map("run_configuration_id")
  configSnapshot     String?         @map("config_snapshot") // JSON snapshot of config at execution time
  triggeredBy        String          @default("manual") @map("triggered_by") // manual, schedule, api, webhook
  startedAt          DateTime?       @map("started_at")
  finishedAt         DateTime?       @map("finished_at")
  createdAt          DateTime        @default(now()) @map("created_at")

  testFlow         TestFlow          @relation(fields: [testFlowId], references: [id], onDelete: Cascade)
  runConfiguration RunConfiguration? @relation(fields: [runConfigurationId], references: [id], onDelete: SetNull)
  logs             ExecutionLog[]
  steps            ExecutionStep[]

  @@index([testFlowId])
  @@index([status])
  @@index([runConfigurationId])
  @@map("executions")
}

model ExecutionLog {
  id          String    @id @default(uuid())
  executionId String    @map("execution_id")
  message     String
  level       String    // info, warn, error
  timestamp   DateTime  @default(now())

  execution   Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@index([timestamp])
  @@map("execution_logs")
}

model ExecutionStep {
  id          String    @id @default(uuid())
  executionId String    @map("execution_id")
  stepNumber  Int       @map("step_number")
  action      String    // navigate, click, fill, expect, etc.
  description String?   // Human readable description
  selector    String?
  selectorName String?  @map("selector_name") // Friendly name like "Login Button"
  value       String?
  url         String?   // URL at time of step
  status      String    @default("pending") // pending, running, passed, failed, skipped
  duration    Int?      // milliseconds
  error       String?   // error message if failed
  screenshot  String?   // screenshot filename
  startedAt   DateTime? @map("started_at")
  finishedAt  DateTime? @map("finished_at")

  execution   Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@index([stepNumber])
  @@map("execution_steps")
}

model Agent {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  name       String
  tokenHash  String    @map("token_hash")
  status     String    @default("offline") // online, offline, busy
  lastSeenAt DateTime? @map("last_seen_at")
  systemInfo String?   @map("system_info")
  createdAt  DateTime  @default(now()) @map("created_at")

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("agents")
}

// ============================================
// VARIABLE SYSTEM MODELS
// ============================================

// Global variables (user-scoped, available everywhere)
model GlobalVariable {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  key         String
  value       String
  type        String   @default("string") // string, number, boolean, json
  sensitive   Boolean  @default(false)    // Mask in UI if true
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, key])
  @@index([userId])
  @@map("global_variables")
}

// Environments (switchable variable sets)
model Environment {
  id          String                @id @default(uuid())
  userId      String                @map("user_id")
  name        String
  description String?
  isActive    Boolean               @default(false) @map("is_active")
  createdAt   DateTime              @default(now()) @map("created_at")
  updatedAt   DateTime              @updatedAt @map("updated_at")

  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  variables   EnvironmentVariable[]

  @@unique([userId, name])
  @@index([userId])
  @@index([isActive])
  @@map("environments")
}

// Environment variables
model EnvironmentVariable {
  id            String      @id @default(uuid())
  environmentId String      @map("environment_id")
  key           String
  value         String
  type          String      @default("string")
  sensitive     Boolean     @default(false)
  description   String?
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  environment   Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)

  @@unique([environmentId, key])
  @@index([environmentId])
  @@map("environment_variables")
}

// Workflow-level variables (shared across flows in a workflow)
model WorkflowVariable {
  id         String   @id @default(uuid())
  workflowId String   @map("workflow_id")
  key        String
  value      String
  type       String   @default("string")
  sensitive  Boolean  @default(false)
  description String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, key])
  @@index([workflowId])
  @@map("workflow_variables")
}

// ============================================
// OBJECT REPOSITORY / PAGE OBJECT MODEL
// ============================================

// Object Repository - container for page objects in a workflow
model ObjectRepository {
  id             String       @id @default(uuid())
  workflowId     String       @unique @map("workflow_id")
  name           String       @default("Object Repository")
  description    String?
  globalElements String?      @map("global_elements") // JSON array of global PageElement
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  workflow       Workflow     @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  pages          PageObject[]

  @@map("object_repositories")
}

// Page Object - represents a page in the application
model PageObject {
  id           String           @id @default(uuid())
  repositoryId String           @map("repository_id")
  name         String
  description  String?
  urlPattern   String?          @map("url_pattern")
  baseUrl      String?          @map("base_url")
  elements     String           @default("[]") // JSON array of PageElement
  order        Int              @default(0)
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  repository   ObjectRepository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@index([repositoryId])
  @@index([order])
  @@map("page_objects")
}

// ============================================
// DATA TABLES (Test Data Management - Legacy)
// ============================================

// DataTable - container for test data rows
model DataTable {
  id          String    @id @default(uuid())
  workflowId  String    @map("workflow_id")
  name        String
  description String?
  columns     String    @default("[]") // JSON: [{name: string, type: 'text'|'number'|'date'|'boolean', required?: boolean}]
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  rows        DataRow[]

  @@unique([workflowId, name])
  @@index([workflowId])
  @@map("data_tables")
}

// DataRow - individual row in a data table
model DataRow {
  id        String    @id @default(uuid())
  tableId   String    @map("table_id")
  data      String    @default("{}") // JSON object matching column schema
  order     Int       @default(0)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  table     DataTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
  @@index([order])
  @@map("data_rows")
}

// ============================================
// TEST DATA SHEETS (Scenario-Based Data Management)
// ============================================

// TestDataSheet - Excel-like sheet mapped to page objects
// One sheet per page object, linked to scenarios via TestID
model TestDataSheet {
  id            String         @id @default(uuid())
  applicationId String         @map("application_id")
  name          String         // "LoginPage", "CheckoutPage"
  pageObject    String?        @map("page_object") // Associated Vero page name
  description   String?
  columns       String         @default("[]") // JSON: [{ name: "email", type: "string", required: true }]
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  application   Application    @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  rows          TestDataRow[]

  @@unique([applicationId, name])
  @@index([applicationId])
  @@map("test_data_sheets")
}

// TestDataRow - individual row linked to a scenario via scenarioId (TestID)
model TestDataRow {
  id          String        @id @default(uuid())
  sheetId     String        @map("sheet_id")
  scenarioId  String        @map("scenario_id") // "TC001", "TC002" - links to @testId tag
  data        String        @default("{}") // JSON: { "email": "user@test.com", "password": "Pass123!" }
  enabled     Boolean       @default(true)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  sheet       TestDataSheet @relation(fields: [sheetId], references: [id], onDelete: Cascade)

  @@unique([sheetId, scenarioId])
  @@index([sheetId])
  @@index([scenarioId])
  @@map("test_data_rows")
}

// ============================================
// SCHEDULED TEST EXECUTION
// ============================================

// Schedule - defines when and which tests to run automatically
model Schedule {
  id                     String        @id @default(uuid())
  userId                 String        @map("user_id")
  workflowId             String?       @map("workflow_id") // Optional: scope to a specific workflow
  name                   String
  description            String?
  cronExpression         String        @map("cron_expression") // e.g., "0 2 * * *" for 2 AM daily
  timezone               String        @default("UTC")
  testSelector           String        @default("{}") @map("test_selector") // JSON: {tags: [], folders: [], patterns: []}
  notificationConfig     String?       @map("notification_config") // JSON: {email: [], slack: {webhook: ""}, onFailureOnly: true}
  isActive               Boolean       @default(true) @map("is_active")
  webhookToken           String?       @unique @map("webhook_token") // Secure token for webhook triggers (64 hex chars)
  nextRunAt              DateTime?     @map("next_run_at")
  lastRunAt              DateTime?     @map("last_run_at")
  createdAt              DateTime      @default(now()) @map("created_at")
  updatedAt              DateTime      @updatedAt @map("updated_at")
  // Parameter system (Jenkins-style)
  parameters             String?       @map("parameters") // JSON: ScheduleParameterDefinition[]
  defaultExecutionConfig String?       @map("default_execution_config") // JSON: ScheduleExecutionConfig

  runs               ScheduleRun[]

  @@index([userId])
  @@index([isActive])
  @@index([nextRunAt])
  @@index([webhookToken])
  @@map("schedules")
}

// ScheduleRun - individual execution of a scheduled test suite
model ScheduleRun {
  id              String    @id @default(uuid())
  scheduleId      String    @map("schedule_id")
  triggerType     String    @default("scheduled") @map("trigger_type") // scheduled, webhook, manual
  status          String    @default("pending") // pending, running, passed, failed, cancelled
  testCount       Int       @default(0) @map("test_count")
  passedCount     Int       @default(0) @map("passed_count")
  failedCount     Int       @default(0) @map("failed_count")
  skippedCount    Int       @default(0) @map("skipped_count")
  durationMs      Int?      @map("duration_ms")
  artifactsPath   String?   @map("artifacts_path") // Path to traces, screenshots
  errorMessage    String?   @map("error_message")
  webhookToken    String?   @map("webhook_token") // Token used if triggered via webhook
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  // Parameter system - what was used for this run
  parameterValues String?   @map("parameter_values") // JSON: ScheduleParameterValues
  executionConfig String?   @map("execution_config") // JSON: ScheduleExecutionConfig
  triggeredByUser String?   @map("triggered_by_user") // User email or "system"

  schedule       Schedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  testResults    ScheduleTestResult[]

  @@index([scheduleId])
  @@index([status])
  @@index([createdAt])
  @@map("schedule_runs")
}

// ScheduleTestResult - individual test result within a scheduled run
model ScheduleTestResult {
  id             String    @id @default(uuid())
  runId          String    @map("run_id")
  testName       String    @map("test_name")
  testPath       String?   @map("test_path") // File path or flow ID
  status         String    @default("pending") // pending, running, passed, failed, skipped
  durationMs     Int?      @map("duration_ms")
  errorMessage   String?   @map("error_message")
  errorStack     String?   @map("error_stack")
  retryCount     Int       @default(0) @map("retry_count")
  screenshotPath String?   @map("screenshot_path")
  tracePath      String?   @map("trace_path")
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")

  run            ScheduleRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([status])
  @@map("schedule_test_results")
}

// ============================================
// ENHANCED SCHEDULING SYSTEM
// ============================================

// ScheduledTest - Enhanced schedule with more configuration options
model ScheduledTest {
  id             String   @id @default(uuid())
  applicationId  String   @map("application_id")
  userId         String   @map("user_id")
  name           String
  description    String?
  testPattern    String   @map("test_pattern") // "tests/**/*.spec.ts" or specific files
  cronExpression String   @map("cron_expression") // "0 9 * * *" = 9am daily
  timezone       String   @default("UTC")
  enabled        Boolean  @default(true)
  config         String   @default("{}") // JSON: ExecutionConfig
  lastRunAt      DateTime? @map("last_run_at")
  nextRunAt      DateTime? @map("next_run_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  application    Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  runs           ScheduledTestRun[]
  notifications  ScheduleNotificationConfig[]

  @@index([applicationId])
  @@index([userId])
  @@index([enabled])
  @@index([nextRunAt])
  @@map("scheduled_tests")
}

// ScheduledTestRun - Individual execution of a scheduled test
model ScheduledTestRun {
  id           String    @id @default(uuid())
  scheduleId   String    @map("schedule_id")
  status       String    @default("queued") // queued, running, completed, failed, cancelled
  triggeredBy  String    @default("schedule") @map("triggered_by") // schedule, manual, api, webhook
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")
  executionId  String?   @map("execution_id") // Link to execution run
  results      String?   // JSON: Summary results
  errorMessage String?   @map("error_message")
  createdAt    DateTime  @default(now()) @map("created_at")

  schedule     ScheduledTest @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
  @@index([status])
  @@index([createdAt])
  @@map("scheduled_test_runs")
}

// ScheduleNotificationConfig - Notification configuration for schedules
model ScheduleNotificationConfig {
  id         String  @id @default(uuid())
  scheduleId String  @map("schedule_id")
  type       String  // 'email', 'slack', 'webhook'
  config     String  @default("{}") // JSON: { email: "...", onFailure: true, onSuccess: false }
  enabled    Boolean @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  schedule   ScheduledTest @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
  @@index([type])
  @@map("schedule_notification_configs")
}

// TestQueue - Queue for pending test executions
model TestQueue {
  id          String    @id @default(uuid())
  scheduleId  String?   @map("schedule_id")
  testPattern String    @map("test_pattern")
  config      String    @default("{}") // JSON: ExecutionConfig
  priority    Int       @default(1) // 0=low, 1=normal, 2=high, 3=critical
  status      String    @default("queued") // queued, running, completed, failed, cancelled
  retryCount  Int       @default(0) @map("retry_count")
  maxRetries  Int       @default(3) @map("max_retries")
  errorMessage String?  @map("error_message")
  createdAt   DateTime  @default(now()) @map("created_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("test_queue")
}

// ============================================
// RUN CONFIGURATION SYSTEM
// ============================================

// ExecutionEnvironment - Defines target environments (dev, staging, prod)
// Different from Environment model which is for variables
model ExecutionEnvironment {
  id          String   @id @default(uuid())
  workflowId  String   @map("workflow_id")
  name        String   // "Development", "Staging", "Production"
  slug        String   // "dev", "staging", "prod"
  baseUrl     String   @map("base_url")
  description String?
  variables   String   @default("{}") // JSON: { API_KEY: "xxx", TIMEOUT: "5000" }
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  runConfigurations RunConfiguration[]

  @@unique([workflowId, slug])
  @@index([workflowId])
  @@map("execution_environments")
}

// RemoteRunner - Remote execution servers (Docker hosts, CI agents)
model RemoteRunner {
  id           String    @id @default(uuid())
  workflowId   String    @map("workflow_id")
  name         String    // "AWS Runner 1", "On-Prem Docker"
  host         String
  port         Int       @default(22)
  authType     String    @default("ssh-key") @map("auth_type") // ssh-key, token, basic
  credentialId String?   @map("credential_id") // Reference to stored credential
  dockerImage  String?   @map("docker_image") // Custom docker image for execution
  maxWorkers   Int       @default(4) @map("max_workers")
  isHealthy    Boolean   @default(true) @map("is_healthy")
  lastPingAt   DateTime? @map("last_ping_at")
  errorMessage String?   @map("error_message")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  runConfigurations RunConfiguration[]

  @@unique([workflowId, name])
  @@index([workflowId])
  @@index([isHealthy])
  @@map("remote_runners")
}

// RunConfiguration - Saved run configurations (like IntelliJ run configs)
model RunConfiguration {
  id          String   @id @default(uuid())
  workflowId  String   @map("workflow_id")
  name        String   // "Smoke Tests - Staging", "Full Suite - Prod"
  description String?
  isDefault   Boolean  @default(false) @map("is_default")

  // Test Filters
  tags         String  @default("[]") // JSON: ["smoke", "critical"]
  tagMode      String  @default("any") @map("tag_mode") // "any" | "all"
  excludeTags  String  @default("[]") @map("exclude_tags") // JSON: ["wip", "flaky"]
  testFlowIds  String  @default("[]") @map("test_flow_ids") // JSON: specific flow IDs or empty for all
  grep         String? // Filter tests by title pattern

  // Environment
  environmentId String? @map("environment_id")

  // Execution Target
  target       String  @default("local") // "local" | "docker" | "github-actions"

  // Target-specific configs (JSON)
  localConfig  String? @map("local_config") // JSON: { workers: number }
  dockerConfig String? @map("docker_config") // JSON: { shardCount, memory, cpus }
  githubActionsConfig String? @map("github_actions_config") // JSON: { runnerType, shardCount, workersPerShard, runnerLabels }

  // Legacy fields (deprecated)
  remoteRunnerId String? @map("remote_runner_id")

  // Browser Settings
  browser      String  @default("chromium") // chromium, firefox, webkit
  browserChannel String? @map("browser_channel") // chrome, chrome-beta, msedge, etc.
  headless     Boolean @default(true)
  viewport     String  @default("{\"width\":1280,\"height\":720}") // JSON

  // Parallel Execution (legacy, use target-specific configs)
  workers      Int     @default(1)
  shardCount   Int     @default(1) @map("shard_count")

  // Retry & Timeout
  retries      Int     @default(0)
  timeout      Int     @default(30000) // ms

  // Artifacts
  tracing      String  @default("on-failure") // on, off, on-failure, on-first-retry, retain-on-failure
  screenshot   String  @default("on-failure") // on, off, on-failure
  video        String  @default("off") // on, off, on-failure, on-first-retry, retain-on-failure

  // GitHub Actions specific
  githubRepository String? @map("github_repository") // "owner/repo"
  githubWorkflowPath String? @map("github_workflow_path") // Path to workflow file

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  environment  ExecutionEnvironment? @relation(fields: [environmentId], references: [id], onDelete: SetNull)
  remoteRunner RemoteRunner?         @relation(fields: [remoteRunnerId], references: [id], onDelete: SetNull)
  executions   Execution[]

  @@unique([workflowId, name])
  @@index([workflowId])
  @@index([isDefault])
  @@map("run_configurations")
}

// StoredCredential - Encrypted credentials for remote runners
model StoredCredential {
  id           String   @id @default(uuid())
  workflowId   String   @map("workflow_id")
  name         String   // "Staging SSH Key", "Docker Registry Token"
  type         String   // "ssh-key", "token", "basic", "docker-registry"
  encryptedValue String @map("encrypted_value") // Encrypted credential data
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([workflowId, name])
  @@index([workflowId])
  @@map("stored_credentials")
}

// ============================================
// AUDIT LOGGING
// ============================================

// AuditLog - Track changes to schedules, configurations, and executions
model AuditLog {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id") // Null for system-triggered events
  entityType  String   @map("entity_type") // "schedule", "execution", "notification", "queue"
  entityId    String   @map("entity_id") // ID of the affected entity
  action      String   // "created", "updated", "deleted", "triggered", "paused", "resumed"
  changes     String?  // JSON: { field: { from: old, to: new } }
  metadata    String?  // JSON: Additional context (IP, user agent, trigger source)
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// NotificationHistory - Track sent notifications
model NotificationHistory {
  id           String    @id @default(uuid())
  scheduleId   String?   @map("schedule_id") // Optional: linked schedule
  runId        String?   @map("run_id") // Optional: linked run
  type         String    // "email", "slack", "webhook"
  recipient    String    // Email address, Slack channel, webhook URL
  subject      String?   // Email subject or notification title
  content      String    // Notification body/payload
  status       String    @default("pending") // pending, sent, failed, bounced
  errorMessage String?   @map("error_message")
  sentAt       DateTime? @map("sent_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  @@index([scheduleId])
  @@index([runId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("notification_history")
}

// ============================================
// GITHUB INTEGRATION
// ============================================

// GitHubIntegration - User's GitHub connection for running tests
model GitHubIntegration {
  id              String    @id @default(uuid())
  userId          String    @unique @map("user_id")
  accessToken     String    @map("access_token") // Encrypted
  tokenType       String    @default("pat") @map("token_type") // "oauth" | "pat"
  scope           String    @default("repo,workflow") // GitHub scopes
  login           String    // GitHub username
  avatarUrl       String?   @map("avatar_url")
  isValid         Boolean   @default(true) @map("is_valid")
  lastValidatedAt DateTime? @map("last_validated_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  repositories    GitHubRepositoryConfig[]

  @@index([userId])
  @@index([isValid])
  @@map("github_integrations")
}

// GitHubRepositoryConfig - Configured repositories for a workflow
model GitHubRepositoryConfig {
  id              String   @id @default(uuid())
  integrationId   String   @map("integration_id")
  workflowId      String   @map("workflow_id")
  repoFullName    String   @map("repo_full_name") // "owner/repo"
  repoId          Int      @map("repo_id")
  defaultBranch   String   @default("main") @map("default_branch")
  workflowPath    String   @default(".github/workflows/vero-tests.yml") @map("workflow_path")
  isActive        Boolean  @default(true) @map("is_active")
  lastSyncedAt    DateTime? @map("last_synced_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  integration     GitHubIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([workflowId, repoFullName])
  @@index([integrationId])
  @@index([workflowId])
  @@map("github_repository_configs")
}

// GitHubWorkflowRun - Track workflow runs triggered from Vero
model GitHubWorkflowRun {
  id              String    @id @default(uuid())
  workflowId      String    @map("workflow_id") // Vero workflow ID
  executionId     String?   @map("execution_id") // Link to Vero Execution
  runId           BigInt    @map("run_id") // GitHub run ID
  runNumber       Int       @map("run_number")
  repoFullName    String    @map("repo_full_name")
  status          String    @default("queued") // queued, in_progress, completed
  conclusion      String?   // success, failure, cancelled, skipped, timed_out
  htmlUrl         String    @map("html_url")
  event           String    @default("workflow_dispatch")
  headBranch      String?   @map("head_branch")
  headSha         String?   @map("head_sha")
  configSnapshot  String?   @map("config_snapshot") // JSON snapshot of run config
  artifactsUrl    String?   @map("artifacts_url")
  logsUrl         String?   @map("logs_url")
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  jobs            GitHubWorkflowJob[]

  @@unique([runId])
  @@index([workflowId])
  @@index([executionId])
  @@index([status])
  @@index([createdAt])
  @@map("github_workflow_runs")
}

// GitHubWorkflowJob - Individual jobs within a workflow run (shards)
model GitHubWorkflowJob {
  id              String    @id @default(uuid())
  runDbId         String    @map("run_db_id") // Reference to GitHubWorkflowRun.id
  jobId           BigInt    @map("job_id") // GitHub job ID
  name            String
  status          String    @default("queued") // queued, in_progress, completed
  conclusion      String?   // success, failure, cancelled, skipped
  htmlUrl         String?   @map("html_url")
  runnerName      String?   @map("runner_name")
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  run             GitHubWorkflowRun @relation(fields: [runDbId], references: [id], onDelete: Cascade)

  @@unique([jobId])
  @@index([runDbId])
  @@index([status])
  @@map("github_workflow_jobs")
}
