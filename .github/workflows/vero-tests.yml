# Vero IDE - Playwright UI Tests with Sharding and Workers
name: Vero Tests

on:
  workflow_dispatch:
    inputs:
      # --- Generic inputs (manual GitHub UI dispatch) ---
      browsers:
        description: 'Browsers (comma-separated: chromium,firefox,webkit)'
        required: false
        default: 'chromium'
        type: string
      workers:
        description: 'Parallel browser instances per job'
        required: false
        default: '2'
        type: string
      shards:
        description: 'Number of parallel jobs'
        required: false
        default: '1'
        type: string
      testPattern:
        description: 'Test file pattern (generic mode only)'
        required: false
        default: 'guaranteed-pass'
        type: string
      # --- Vero-specific inputs (IDE-triggered dispatch) ---
      runMode:
        description: 'Execution mode: "vero" for IDE content, empty for generic'
        required: false
        default: ''
        type: string
      veroFilePath:
        description: 'Relative path to .vero file'
        required: false
        default: ''
        type: string
      veroContentB64:
        description: 'Base64-encoded Vero file content'
        required: false
        default: ''
        type: string
      retries:
        description: 'Test retry count'
        required: false
        default: '0'
        type: string
      timeoutMs:
        description: 'Test timeout in milliseconds'
        required: false
        default: '60000'
        type: string
      headless:
        description: 'Run headless'
        required: false
        default: 'true'
        type: string
      scenarioName:
        description: 'Specific Vero scenario name to run'
        required: false
        default: ''
        type: string
      selectionScope:
        description: 'Vero selection scope: active-file or current-sandbox'
        required: false
        default: 'current-sandbox'
        type: string
      tagExpression:
        description: 'Cucumber-style tag expression (e.g., (@smoke and @login) and not @dashboard)'
        required: false
        default: ''
        type: string
      parameterizedNamesB64:
        description: 'Base64-encoded JSON array of parameterized variable names'
        required: false
        default: ''
        type: string
      namePatternsB64:
        description: 'Base64-encoded JSON array of scenario name regex patterns'
        required: false
        default: ''
        type: string
      tagsB64:
        description: 'Base64-encoded JSON array of legacy include tags'
        required: false
        default: ''
        type: string
      tagMode:
        description: 'Legacy include tag mode: any/all'
        required: false
        default: 'any'
        type: string
      excludeTagsB64:
        description: 'Base64-encoded JSON array of legacy exclude tags'
        required: false
        default: ''
        type: string
      grep:
        description: 'Secondary Playwright --grep filter'
        required: false
        default: ''
        type: string
      grepInvert:
        description: 'Secondary Playwright --grep-invert filter'
        required: false
        default: ''
        type: string
      lastFailed:
        description: 'Run Playwright last-failed tests only'
        required: false
        default: 'false'
        type: string
      baseUrl:
        description: 'Base URL for tests'
        required: false
        default: ''
        type: string
      envVarsB64:
        description: 'Base64-encoded JSON environment variables'
        required: false
        default: ''
        type: string

jobs:
  test:
    name: Tests (Shard ${{ matrix.shard }}/${{ inputs.shards || '1' }})
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: ${{ fromJson(format('[{0}]', (inputs.shards == '4' && '1,2,3,4') || (inputs.shards == '3' && '1,2,3') || (inputs.shards == '2' && '1,2') || '1')) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            backend/package-lock.json
            shared/package-lock.json
            vero-lang/package-lock.json
            tests/package-lock.json

      # --- Generic mode dependencies ---
      - name: Install test dependencies (generic mode)
        if: ${{ inputs.runMode != 'vero' }}
        working-directory: ./tests
        run: npm ci

      - name: Install Playwright browsers (generic mode)
        if: ${{ inputs.runMode != 'vero' }}
        working-directory: ./tests
        run: |
          BROWSERS="${{ inputs.browsers || 'chromium' }}"
          for browser in ${BROWSERS//,/ }; do
            npx playwright install --with-deps $browser
          done

      # --- Vero mode dependencies ---
      - name: Restore shared dist cache (Vero mode)
        id: shared_dist_cache
        if: ${{ inputs.runMode == 'vero' }}
        uses: actions/cache@v4
        with:
          path: shared/dist
          key: shared-dist-${{ runner.os }}-${{ hashFiles('shared/src/**/*.ts', 'shared/tsconfig.json', 'shared/package-lock.json') }}

      - name: Install shared dependencies (Vero mode)
        if: ${{ inputs.runMode == 'vero' && steps.shared_dist_cache.outputs.cache-hit != 'true' }}
        working-directory: ./shared
        run: npm ci

      - name: Build shared package (Vero mode)
        if: ${{ inputs.runMode == 'vero' && steps.shared_dist_cache.outputs.cache-hit != 'true' }}
        working-directory: ./shared
        run: npm run build

      - name: Restore vero-lang dist cache (Vero mode)
        id: vero_lang_dist_cache
        if: ${{ inputs.runMode == 'vero' }}
        uses: actions/cache@v4
        with:
          path: vero-lang/dist
          key: vero-lang-dist-${{ runner.os }}-${{ hashFiles('vero-lang/src/**/*.ts', 'vero-lang/grammar/**', 'vero-lang/tsconfig.json', 'vero-lang/package-lock.json') }}

      - name: Restore vero-lang node_modules cache (Vero mode)
        id: vero_lang_modules_cache
        if: ${{ inputs.runMode == 'vero' }}
        uses: actions/cache@v4
        with:
          path: vero-lang/node_modules
          key: vero-lang-node-modules-${{ runner.os }}-${{ hashFiles('vero-lang/package-lock.json') }}

      - name: Install vero-lang dependencies (Vero mode)
        if: ${{ inputs.runMode == 'vero' && steps.vero_lang_modules_cache.outputs.cache-hit != 'true' }}
        working-directory: ./vero-lang
        run: npm ci

      - name: Build vero-lang package (Vero mode)
        if: ${{ inputs.runMode == 'vero' && steps.vero_lang_dist_cache.outputs.cache-hit != 'true' }}
        working-directory: ./vero-lang
        run: npm run build

      - name: Install backend dependencies (Vero mode)
        if: ${{ inputs.runMode == 'vero' }}
        working-directory: ./backend
        run: npm ci

      - name: Restore Playwright browser cache (Vero mode)
        id: pw_cache_vero
        if: ${{ inputs.runMode == 'vero' }}
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: pw-vero-${{ runner.os }}-${{ hashFiles('backend/package-lock.json') }}

      - name: Install Playwright browsers (Vero mode)
        if: ${{ inputs.runMode == 'vero' && steps.pw_cache_vero.outputs.cache-hit != 'true' }}
        working-directory: ./backend
        run: npx playwright install --with-deps chromium

      # --- Dual-mode test execution ---
      - name: Run Vero tests (IDE mode)
        if: ${{ inputs.runMode == 'vero' }}
        working-directory: ./backend
        run: ./node_modules/.bin/tsx scripts/run-vero-workflow.ts
        env:
          CI: true
          VERO_FILE_PATH: ${{ inputs.veroFilePath }}
          VERO_CONTENT_B64: ${{ inputs.veroContentB64 }}
          WORKERS: ${{ inputs.workers || '1' }}
          SHARD_INDEX: ${{ matrix.shard }}
          SHARD_TOTAL: ${{ inputs.shards || '1' }}
          RETRIES: ${{ inputs.retries || '0' }}
          TIMEOUT_MS: ${{ inputs.timeoutMs || '60000' }}
          HEADLESS: ${{ inputs.headless || 'true' }}
          SCENARIO_NAME: ${{ inputs.scenarioName }}
          SELECTION_SCOPE: ${{ inputs.selectionScope || 'current-sandbox' }}
          TAG_EXPRESSION: ${{ inputs.tagExpression }}
          PARAMETERIZED_NAMES_B64: ${{ inputs.parameterizedNamesB64 }}
          NAME_PATTERNS_B64: ${{ inputs.namePatternsB64 }}
          TAGS_B64: ${{ inputs.tagsB64 }}
          TAG_MODE: ${{ inputs.tagMode || 'any' }}
          EXCLUDE_TAGS_B64: ${{ inputs.excludeTagsB64 }}
          GREP: ${{ inputs.grep }}
          GREP_INVERT: ${{ inputs.grepInvert }}
          LAST_FAILED: ${{ inputs.lastFailed || 'false' }}
          ENV_VARS_B64: ${{ inputs.envVarsB64 }}
          BASE_URL: ${{ inputs.baseUrl }}

      - name: Run Playwright tests (generic mode)
        if: ${{ inputs.runMode != 'vero' }}
        working-directory: ./tests
        run: |
          BROWSERS="${{ inputs.browsers || 'chromium' }}"
          PROJECTS=""
          for browser in ${BROWSERS//,/ }; do
            PROJECTS="$PROJECTS --project=$browser"
          done

          npx playwright test \
            $PROJECTS \
            --workers=${{ inputs.workers || '2' }} \
            --shard=${{ matrix.shard }}/${{ inputs.shards || '1' }} \
            ${{ inputs.testPattern || 'guaranteed-pass' }}.spec.ts
        env:
          CI: true

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        if: ${{ always() && inputs.runMode != 'vero' }}
        with:
          name: playwright-report-shard-${{ matrix.shard }}
          path: tests/playwright-report/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload JSON results (generic mode)
        uses: actions/upload-artifact@v4
        if: ${{ always() && inputs.runMode != 'vero' }}
        with:
          name: test-results-shard-${{ matrix.shard }}
          path: tests/test-results/results.json
          retention-days: 7

      - name: Upload JSON results (Vero mode)
        uses: actions/upload-artifact@v4
        if: ${{ always() && inputs.runMode == 'vero' }}
        with:
          name: test-results-shard-${{ matrix.shard }}
          path: backend/.vero-ci/test-results/**/results.json
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload traces (generic mode)
        uses: actions/upload-artifact@v4
        if: ${{ always() && inputs.runMode != 'vero' }}
        with:
          name: test-traces-shard-${{ matrix.shard }}
          path: tests/test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload traces (Vero mode)
        uses: actions/upload-artifact@v4
        if: ${{ always() && inputs.runMode == 'vero' }}
        with:
          name: test-traces-shard-${{ matrix.shard }}
          path: backend/.vero-ci/test-results/**/artifacts/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Allure Results (generic mode)
        uses: actions/upload-artifact@v4
        if: ${{ always() && inputs.runMode != 'vero' }}
        with:
          name: allure-results-shard-${{ matrix.shard }}
          path: tests/allure-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Allure Results (Vero mode)
        uses: actions/upload-artifact@v4
        if: ${{ always() && inputs.runMode == 'vero' }}
        with:
          name: allure-results-shard-${{ matrix.shard }}
          path: backend/.vero-ci/test-results/**/allure-results/
          retention-days: 7
          if-no-files-found: ignore

  merge-reports:
    name: Merge Reports
    needs: test
    if: ${{ always() && inputs.runMode != 'vero' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download Playwright artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: playwright-report-*
          merge-multiple: true
          path: merged-playwright-report

      - name: Upload merged Playwright report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-merged
          path: merged-playwright-report/
          retention-days: 14

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Allure 3 CLI
        run: npm install -g allure@3

      - name: Download Allure results
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          merge-multiple: true
          path: allure-results-merged
        continue-on-error: true

      - name: Generate merged Allure report
        run: |
          if [ -d "allure-results-merged" ] && [ "$(ls -A allure-results-merged 2>/dev/null)" ]; then
            allure generate allure-results-merged --clean -o allure-report-merged
          else
            echo "No Allure results to merge"
          fi

      - name: Upload merged Allure report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report-merged
          path: allure-report-merged/
          retention-days: 14
          if-no-files-found: ignore
